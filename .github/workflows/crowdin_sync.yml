name: Sync translations with Crowdin

on:
  push:
    branches: [ maincr ]
    #paths:
    #  - '**/Resources*.resx'
  workflow_dispatch:

env:
  # The git branch used for sync with crowdin to keep track of changes from crowdin.
  # Also used for the pull request. Must not be deleted even after the PR is merged!
  BRANCH: crowdin
  # crowdin config
  CONFIG: '.github/.crowdin.yml'
  PROJECT: ${{ secrets.CROWDIN_PROJECT_ID }}
  TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}
  
concurrency:
  group: ${{ github.workflow }}

jobs:
  sync:
    name: Sync translations with crowdin
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Prepare branches
      run: |
        git config user.name "Crowdin Bot"
        git config user.email "<>"
        git checkout $BRANCH 2>/dev/null || git checkout --track origin/$BRANCH $GITHUB_REF
        
    - name: Setup crowdin cli
      run: |
        wget https://artifacts.crowdin.com/repo/deb/crowdin3.deb -O crowdin.deb --no-verbose
        sudo dpkg -i crowdin.deb
        REF=main # $(basename $GITHUB_REF)
        ARGS="--branch=$REF --base-path=. --config=$CONFIG --project-id=$PROJECT --token=$TOKEN --no-progress"
        echo "ARGS=$ARGS" >> $GITHUB_ENV

    - name: Download changes from crowdin
      run: |
        crowdin download sources $ARGS
        crowdin download $ARGS
        git status -s
        git add .
        git commit -m "Update from crowdin" --allow-empty 

    - name: Merge and resolve conflicts
      run: |     
        git merge $GITHUB_REF -Xtheirs -v

    - name: Upload to crowdin
      run: |
        crowdin upload sources --delete-obsolete $ARGS
        crowdin upload translations $ARGS

    - name: Clean branch
      run: |
        git checkout -B $BRANCH $GITHUB_REF

    - name: Download from crowdin
      run: |
        crowdin download sources $ARGS
        crowdin download $ARGS
        git status -s    

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v4.2.3
      with:
        base: $GITHUB_REF
        branch: $BRANCH
        commit-message: Update from crowdin
        title: Translation
        body: Update from crowdin



